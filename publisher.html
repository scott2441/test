<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è²¼ä¸Šç¨‹å¼ç¢¼ â†’ ä¸€éµç™¼ä½ˆ GitHub Pages</title>
  <style>
    :root{--b:#111;--g:#666;--bd:#ddd;--bg:#fafafa;--ok:#0a7;--bad:#c33;}
    body{font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;margin:24px;line-height:1.5;color:#111;}
    h1{margin:0 0 8px;font-size:1.35rem;}
    .sub{color:var(--g);margin:0 0 16px;}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;}
    @media(min-width:980px){.grid{grid-template-columns:1.1fr .9fr;align-items:start;}}
    .card{border:1px solid var(--bd);border-radius:12px;padding:14px;background:#fff;}
    label{display:block;margin:10px 0 6px;font-size:.95rem;color:#222;}
    input[type="text"],input[type="password"]{width:100%;padding:10px 12px;border:1px solid var(--bd);border-radius:10px;font-size:1rem;}
    textarea{width:100%;min-height:360px;padding:12px;border:1px solid var(--bd);border-radius:12px;font-size:14px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;}
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .row > *{flex:1 1 200px;}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    button{padding:10px 14px;border-radius:10px;border:1px solid var(--b);background:#fff;cursor:pointer;font-size:1rem;}
    button.primary{background:var(--b);color:#fff;border-color:var(--b);}
    button:disabled{opacity:.55;cursor:not-allowed;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;}
    .status{margin-top:12px;padding:12px;border:1px solid var(--bd);border-radius:12px;background:var(--bg);}
    .ok{color:var(--ok);font-weight:700;}
    .bad{color:var(--bad);font-weight:700;}
    a{color:#0b62d6;text-decoration:none}
    a:hover{text-decoration:underline}
    .hint{color:var(--g);font-size:.92rem;margin-top:6px}
    .small{color:var(--g);font-size:.9rem}
    iframe{width:100%;height:360px;border:1px solid var(--bd);border-radius:12px;background:#fff;}
  </style>
</head>
<body>
  <h1>è²¼ä¸Šç¨‹å¼ç¢¼ â†’ ä¸€éµç™¼ä½ˆ GitHub Pages</h1>
  <p class="sub">æŠŠä½ çš„ HTML è²¼ä¸Š â†’ æŒ‰ã€Œç™¼ä½ˆã€â†’ å–å¾—ç¶²å€çµ¦åˆ¥äººç”¨ã€‚å…¨éƒ¨åœ¨ç€è¦½å™¨æœ¬æ©Ÿå®Œæˆï¼ˆé€é GitHub API ä¸Šå‚³ï¼‰ã€‚</p>

  <div class="grid">
    <div class="card">
      <div class="row">
        <div>
          <label>æª”åï¼ˆæœƒæ”¾åœ¨ repo æ ¹ç›®éŒ„ï¼‰</label>
          <input id="filename" type="text" value="index.html" />
          <div class="hint">å»ºè­°ç”¨ <span class="mono">index.html</span>ï¼Œç¶²å€æœ€ä¹¾æ·¨ã€‚</div>
        </div>
        <div>
          <label>åˆ†æ”¯ï¼ˆå»ºè­° mainï¼‰</label>
          <input id="branch" type="text" value="main" />
        </div>
      </div>

      <label>è²¼ä¸Šä½ çš„ HTML ç¨‹å¼ç¢¼</label>
      <textarea id="code" spellcheck="false" placeholder="è²¼ä¸Šå®Œæ•´ HTMLï¼ˆå»ºè­°åŒ…å« <!doctype html> ... </html>ï¼‰"></textarea>

      <div class="btns">
        <button id="previewBtn">é è¦½</button>
        <button class="primary" id="publishBtn">ä¸€éµç™¼ä½ˆï¼ˆGitHub Pagesï¼‰</button>
        <button id="saveLocalBtn">å­˜åˆ°æœ¬æ©Ÿï¼ˆå‚™ä»½ï¼‰</button>
        <button id="fillSampleBtn">å¡«å…¥ç¯„ä¾‹</button>
      </div>

      <div class="hint">å®‰å…¨æé†’ï¼šToken åªåœ¨ä½ ç€è¦½å™¨å…§ä½¿ç”¨ï¼Œä¸æœƒä¸Šå‚³åˆ°æˆ‘é€™è£¡ï¼›ä½†ä»å»ºè­°ç”¨ Fine-grained token ä¸¦é™åˆ¶ repo æ¬Šé™ã€‚</div>
    </div>

    <div class="card">
      <label>GitHub å¸³è™Ÿï¼ˆownerï¼‰</label>
      <input id="owner" type="text" placeholder="ä¾‹å¦‚ï¼šepchen" />

      <label>Repository åç¨±ï¼ˆä¸å­˜åœ¨æœƒå˜—è©¦è‡ªå‹•å»ºç«‹ï¼‰</label>
      <input id="repo" type="text" placeholder="ä¾‹å¦‚ï¼švocab-quiz" />

      <label>Commit è¨Šæ¯</label>
      <input id="message" type="text" value="Publish quiz" />

      <label>GitHub Tokenï¼ˆä¸æœƒé¡¯ç¤ºï¼‰</label>
      <input id="token" type="password" placeholder="ghp_... æˆ– fine-grained token" />

      <div class="status" id="statusBox">
        <div><strong>ç‹€æ…‹</strong></div>
        <div id="statusText" class="small">å°šæœªæ“ä½œ</div>
        <div id="links" style="margin-top:8px;"></div>
      </div>

      <div style="margin-top:12px;">
        <div class="small"><strong>é è¦½å€</strong>ï¼ˆæŒ‰ã€Œé è¦½ã€æ›´æ–°ï¼‰</div>
        <iframe id="previewFrame" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
      </div>
    </div>
  </div>

<script>
  const el = (id)=>document.getElementById(id);
  const filenameEl = el("filename");
  const branchEl = el("branch");
  const codeEl = el("code");
  const ownerEl = el("owner");
  const repoEl = el("repo");
  const msgEl = el("message");
  const tokenEl = el("token");
  const statusText = el("statusText");
  const linksEl = el("links");
  const previewFrame = el("previewFrame");

  const previewBtn = el("previewBtn");
  const publishBtn = el("publishBtn");
  const saveLocalBtn = el("saveLocalBtn");
  const fillSampleBtn = el("fillSampleBtn");

  function setStatus(html, ok=true){
    statusText.innerHTML = ok ? `<span class="ok">${html}</span>` : `<span class="bad">${html}</span>`;
  }
  function setLinks(html){ linksEl.innerHTML = html || ""; }

  function normalizeFilename(name){
    let n = (name||"").trim();
    if(!n) n = "index.html";
    if(!n.toLowerCase().endsWith(".html")) n += ".html";
    n = n.replace(/[\\/:*?"<>|]+/g,"-");
    return n;
  }

  function ensureHtmlSkeleton(code){
    const c = (code||"").trim();
    const hasDoctype = /^<!doctype html>/i.test(c);
    const hasHtmlTag = /<html[\s>]/i.test(c);
    if(hasDoctype || hasHtmlTag) return c;
    return `<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Page</title>
</head>
<body>
${c}
</body>
</html>`;
  }

  function b64EncodeUnicode(str){
    // base64 for UTF-8
    const bytes = new TextEncoder().encode(str);
    let bin = "";
    bytes.forEach(b=>bin += String.fromCharCode(b));
    return btoa(bin);
  }

  async function ghFetch(url, token, opts={}){
    const res = await fetch(url, {
      ...opts,
      headers: {
        "Accept": "application/vnd.github+json",
        "Authorization": `Bearer ${token}`,
        "X-GitHub-Api-Version": "2022-11-28",
        ...(opts.headers || {})
      }
    });
    const text = await res.text();
    let json = null;
    try{ json = text ? JSON.parse(text) : null; }catch(e){}
    return { ok: res.ok, status: res.status, json, text };
  }

  async function ensureRepoExists(owner, repo, token){
    // 1) check repo
    const check = await ghFetch(`https://api.github.com/repos/${owner}/${repo}`, token);
    if(check.ok) return { created:false };

    // 2) create repo under authenticated user (must match owner)
    const me = await ghFetch(`https://api.github.com/user`, token);
    if(!me.ok) throw new Error(`ç„¡æ³•å–å¾—ç™»å…¥è€…è³‡è¨Šï¼ˆtoken å¯èƒ½ç„¡æ•ˆï¼‰`);
    const login = me.json?.login;
    if(!login) throw new Error(`ç„¡æ³•å–å¾— login`);
    if(login.toLowerCase() !== owner.toLowerCase()){
      throw new Error(`Repo ä¸å­˜åœ¨ï¼Œä¸”ä½ çš„ token ç™»å…¥è€…æ˜¯ ${login}ï¼Œä½† owner å¡«çš„æ˜¯ ${owner}ã€‚è«‹æ”¹æˆä¸€è‡´ï¼Œæˆ–å…ˆæ‰‹å‹•å»ºç«‹ repoã€‚`);
    }

    const created = await ghFetch(`https://api.github.com/user/repos`, token, {
      method:"POST",
      body: JSON.stringify({
        name: repo,
        description: "Published by HTML Publisher",
        "private": false,
        auto_init: true
      })
    });
    if(!created.ok){
      const m = created.json?.message || created.text || `å»ºç«‹ repo å¤±æ•—`;
      throw new Error(m);
    }
    return { created:true };
  }

  async function putFile(owner, repo, path, branch, contentUtf8, message, token){
    // check if file exists to get sha
    const get = await ghFetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`, token);
    const sha = get.ok ? get.json?.sha : undefined;

    const body = {
      message: message || `Update ${path}`,
      content: b64EncodeUnicode(contentUtf8),
      branch
    };
    if(sha) body.sha = sha;

    const put = await ghFetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`, token, {
      method:"PUT",
      body: JSON.stringify(body)
    });
    if(!put.ok){
      const m = put.json?.message || put.text || `ä¸Šå‚³æª”æ¡ˆå¤±æ•—`;
      throw new Error(m);
    }
    return put.json;
  }

  async function enablePages(owner, repo, branch, token){
    // Try create pages
    const create = await ghFetch(`https://api.github.com/repos/${owner}/${repo}/pages`, token, {
      method:"POST",
      body: JSON.stringify({ source: { branch, path: "/" } })
    });
    if(create.ok) return { enabled:true, method:"create" };

    // If already exists, try update
    // Some repos return 409/422 if Pages already enabled or pending.
    const patch = await ghFetch(`https://api.github.com/repos/${owner}/${repo}/pages`, token, {
      method:"PUT",
      body: JSON.stringify({ source: { branch, path: "/" } })
    });
    if(patch.ok) return { enabled:true, method:"update" };

    return { enabled:false, create, patch };
  }

  function pagesUrl(owner, repo, filename){
    // If index.html, base URL is enough.
    const base = `https://${owner}.github.io/${repo}/`;
    if(filename.toLowerCase() === "index.html") return base;
    return base + encodeURIComponent(filename);
  }

  function preview(){
    const raw = codeEl.value;
    if(!raw.trim()){
      setStatus("ä½ é‚„æ²’è²¼ä¸Šç¨‹å¼ç¢¼", false);
      return;
    }
    previewFrame.srcdoc = ensureHtmlSkeleton(raw);
    setStatus("é è¦½å·²æ›´æ–°");
  }

  function downloadLocal(){
    const raw = codeEl.value;
    if(!raw.trim()){
      setStatus("ä½ é‚„æ²’è²¼ä¸Šç¨‹å¼ç¢¼", false);
      return;
    }
    const name = normalizeFilename(filenameEl.value);
    const code = ensureHtmlSkeleton(raw);
    const blob = new Blob([code], { type:"text/html;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = name;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    setStatus(`å·²ä¸‹è¼‰æœ¬æ©Ÿå‚™ä»½ï¼š${name}`);
  }

  function fillSample(){
    ownerEl.value = ownerEl.value || "";
    repoEl.value = repoEl.value || "my-pages";
    filenameEl.value = "index.html";
    codeEl.value = `<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ¸¬è©¦ç™¼ä½ˆ</title>
  <style>body{font-family:system-ui;margin:24px} .card{border:1px solid #ddd;border-radius:12px;padding:14px}</style>
</head>
<body>
  <h1>é€™æ˜¯ GitHub Pages æ¸¬è©¦é </h1>
  <div class="card">å¦‚æœä½ çœ‹åˆ°é€™é ï¼Œä»£è¡¨ç™¼ä½ˆæˆåŠŸï¼</div>
</body>
</html>`;
    setStatus("å·²å¡«å…¥ç¯„ä¾‹");
    preview();
  }

  async function publish(){
    setLinks("");
    const owner = ownerEl.value.trim();
    const repo = repoEl.value.trim();
    const token = tokenEl.value.trim();
    const branch = branchEl.value.trim() || "main";
    const filename = normalizeFilename(filenameEl.value);
    const message = msgEl.value.trim() || "Publish";
    const raw = codeEl.value;

    if(!owner || !repo || !token){
      setStatus("è«‹å¡« owner / repo / token", false);
      return;
    }
    if(!raw.trim()){
      setStatus("ä½ é‚„æ²’è²¼ä¸Šç¨‹å¼ç¢¼", false);
      return;
    }

    publishBtn.disabled = true;
    setStatus("é–‹å§‹è™•ç†ä¸­â€¦");

    try{
      // Ensure repo exists
      setStatus("æª¢æŸ¥ / å»ºç«‹ Repositoryâ€¦");
      const r = await ensureRepoExists(owner, repo, token);

      // Upload file
      setStatus(`ä¸Šå‚³æª”æ¡ˆï¼š${filename}â€¦`);
      const code = ensureHtmlSkeleton(raw);
      await putFile(owner, repo, filename, branch, code, message, token);

      // Try enable Pages
      setStatus("å•Ÿç”¨ GitHub Pagesâ€¦ï¼ˆè‹¥å¤±æ•—å¯æ‰‹å‹•é–‹å•Ÿï¼‰");
      const pages = await enablePages(owner, repo, branch, token);

      const url = pagesUrl(owner, repo, filename);
      const repoUrl = `https://github.com/${owner}/${repo}`;
      const settingsUrl = `https://github.com/${owner}/${repo}/settings/pages`;

      let msg = `ç™¼ä½ˆå®Œæˆï¼`;
      if(!pages.enabled){
        msg += `ï¼ˆPages è‡ªå‹•å•Ÿç”¨å¯èƒ½å¤±æ•—ï¼Œè«‹åˆ° Settings â†’ Pages æ‰‹å‹•è¨­å®š Branch=${branch} / rootï¼‰`;
      }
      setStatus(msg, true);

      setLinks(`
        <div>âœ… Repoï¼š<a href="${repoUrl}" target="_blank" rel="noreferrer">${repoUrl}</a></div>
        <div>ğŸŒ Pagesï¼š<a href="${url}" target="_blank" rel="noreferrer">${url}</a></div>
        <div class="small">è‹¥ Pages å°šæœªç”Ÿæ•ˆï¼šåˆ° <a href="${settingsUrl}" target="_blank" rel="noreferrer">Settings â†’ Pages</a> è¨­å®š <span class="mono">${branch}</span> + <span class="mono">/(root)</span>ï¼Œç­‰ 1~2 åˆ†é˜ã€‚</div>
      `);

    }catch(err){
      setStatus(`å¤±æ•—ï¼š${(err && err.message) ? err.message : String(err)}`, false);
      setLinks(`<div class="small">å¸¸è¦‹åŸå› ï¼šToken æ¬Šé™ä¸è¶³ã€owner ä¸ç­‰æ–¼ token ç™»å…¥è€…ã€repo å·²å­˜åœ¨ä½†ä½ æ²’æ¬Šé™ã€‚</div>`);
    }finally{
      publishBtn.disabled = false;
    }
  }

  previewBtn.addEventListener("click", preview);
  publishBtn.addEventListener("click", publish);
  saveLocalBtn.addEventListener("click", downloadLocal);
  fillSampleBtn.addEventListener("click", fillSample);

  // Cmd/Ctrl+Enterï¼šé è¦½
  document.addEventListener("keydown", (e)=>{
    const isMac = navigator.platform.toLowerCase().includes("mac");
    if((isMac && e.metaKey && e.key === "Enter") || (!isMac && e.ctrlKey && e.key === "Enter")){
      e.preventDefault();
      preview();
    }
  });
</script>
</body>
</html>
